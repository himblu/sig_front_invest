<div class="animated fadeIn fast">
  <div class="form-row">
    <div class="col-12" *ngIf="newAssignment">
      <form #newAssignmentForm="ngForm">
        <div class="card">
          <div class="card-header p-2">
            <div class="form-row">
              <div class="col-8">
                <button class="btn btn-light btn-sm text-danger mr-1" (click)="back()">
                  <i class="fa fa-chevron-left mr-1"></i>Volver
                </button>
                <strong class="text-primary-color">
                  {{newAssignment.editing ? 'Editando' : 'Nueva'}}&nbsp;Asignación de Curso
                </strong>
              </div>
              <div class="col-4 text-right">
                <span class="badge mt-1 mr-2 badge-light text-warning" *ngIf="(newAssignment.typeCategory !== 2 && timeDistributionGenerated) && newAssignment.inSelect != newAssignment.durationHours">
                  <i class="fa fa-info mr-1"></i>Debes asignar todas las horas señaladas.
                </span>
                <button class="btn btn-sm bg-primary-color" [disabled]="!signatories.length || !timeDistributionGenerated || newAssignmentForm.invalid || (newAssignment.typeCategory !== 2 && newAssignment.inSelect != newAssignment.durationHours)" (click)="saveChanges()">
                  <i class="fa fa-check mr-1"></i>Guardar
                </button>
              </div>
            </div>
          </div>
          <div class="card-body p-2">
            <tabset>
              <tab heading="General">
                <div class="card">
                  <div class="card-body">
                    <div class="form-row">
                      <div class="col-3">
                        <div class="form-group">
                          <label for="typeCertificationID">Categoría</label>
                          <select name="typeCategory" (change)="toggleTimeDistribution()" [(ngModel)]="newAssignment.typeCategory" class="form-control form-control-sm" required  [disabled]="newAssignment.editing" >
                            <option [ngValue]="undefined">--SELECCIONE--</option>
                            <option *ngFor="let c of typeCategory" [ngValue]="c.id">{{c.name | uppercase}}</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-3">
                        <div class="form-group">
                          <label for="typeCertificationID">Tipo de Curso</label>
                          <select name="typeCertificationID" [(ngModel)]="newAssignment.typeCertificationID" class="form-control form-control-sm" required>
                            <option [ngValue]="undefined">--SELECCIONE--</option>
                            <option *ngFor="let c of typeCertifications" [ngValue]="c.typeCertificationID">{{c.typeCertificationDesc | uppercase}}</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-3">
                        <div class="form-group">
                          <label for="classSessionID">Modalidad</label>
                          <select name="classSessionID" [(ngModel)]="newAssignment.classSessionID" class="form-control form-control-sm" required>
                            <option [ngValue]="undefined">--SELECCIONE--</option>
                            <option *ngFor="let c of classSessions" [ngValue]="c.classSessionID">{{c.classSessionDesc | uppercase}}</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-3">
                        <div class="form-group">
                          <label for="courseID">Curso</label>
                          <select name="courseID" [(ngModel)]="newAssignment.courseID" class="form-control form-control-sm" required>
                            <option [ngValue]="undefined">--SELECCIONE--</option>
                            <option *ngFor="let c of courses" [ngValue]="c.extensionCoursesID">{{c.courseName | uppercase}}</option>
                          </select>
                        </div>
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="col">
                        <div class="form-group">
                          <label for="typeTeacherID">Tipo de Docente</label>
                          <select name="typeTeacherID" [(ngModel)]="newAssignment.typeTeacherID"  class="form-control form-control-sm" required (change)="changeTypeTeacher($event)">
                            <option [ngValue]="undefined">--SELECCIONE--</option>
                            <option *ngFor="let c of typeTeachers" [ngValue]="c.typeTeacherID">{{c.typeTeacherDesc | uppercase}}</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-1 d-flex align-items-end" style="padding: 7px;" *ngIf="newAssignment.typeTeacherID==2">
                        <button class="btn btn-sm bg-primary-color"  (click)="toggleUsersModal();">
                          <i class="fa fa-plus"></i>
                        </button>
                      </div>
                      <div class="col-4">
                        <div class="form-group">
                          <label for="teacherID">Docente</label>
                          <mat-select name="teacherID" [(ngModel)]="newAssignment.teacherID" class="form-control form-control-sm d-flex" required multiple style="height: 30px;">
                            <mat-option *ngFor="let option of teachers" [value]="option">
                              <mat-icon class="user-icon">person</mat-icon>
                              <span>
                                {{ option.PersonFullName ? option.PersonFullName : '' }}
                              </span>
                            </mat-option>
                          </mat-select>
                        </div>
                      </div>
                      <div class="col-2">
                        <label for="costSection">Horas virtuales</label>
                        <input type="number" name="NroHrasVirt" [(ngModel)]="newAssignment.NroHrasVirt" class="form-control form-control-sm"
                        [required]="newAssignment.typeCategory === 2" [disabled]="newAssignment.typeCategory !== 2">
                      </div>
                      <div class="col-2">
                        <label for="costSection">Horas presenciales</label>
                        <input type="number" name="NroHrasPres" [(ngModel)]="newAssignment.NroHrasPres" class="form-control form-control-sm"
                        [required]="newAssignment.typeCategory === 2" [disabled]="newAssignment.typeCategory !== 2">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="col-2">
                        <label for="costSection">Costo</label>
                        <input type="number" name="costSection" [(ngModel)]="newAssignment.costSection" class="form-control form-control-sm" required>
                      </div>
                      <div class="col-2">
                        <label for="durationHours">Horas del Curso <span class="ml-2" *ngIf="(timeDistributionGenerated && newAssignment.typeCategory !== 2) && newAssignment.inSelect != newAssignment.durationHours">(Faltan escoger {{newAssignment.durationHours - newAssignment.inSelect}}h.)</span> </label>
                        <input type="number" name="durationHours" [ngClass]="{'is-invalid': (timeDistributionGenerated && newAssignment.typeCategory !== 2) && newAssignment.inSelect != newAssignment.durationHours}" [(ngModel)]="newAssignment.durationHours" class="form-control form-control-sm" required>
                      </div>
                      <div class="col-2">
                        <label for="minVacancies">Min. Vacantes</label>
                        <input type="number" name="minVacancies" [(ngModel)]="newAssignment.minVacancies" class="form-control form-control-sm" required>
                      </div>
                      <div class="col-2">
                        <label for="maxVacancies">Max Vacantes</label>
                        <input type="number" name="maxVacancies" [min]="newAssignment.minVacancies" [(ngModel)]="newAssignment.maxVacancies" class="form-control form-control-sm" required>
                      </div>
                      <div class="col-2">
                        <label for="startDate">Inicio</label>
                        <input type="date" name="startDate" [min]="currentDate" [(ngModel)]="newAssignment.startDate" class="form-control form-control-sm" required>
                      </div>
                      <div class="col-2">
                        <label for="endDate">Fin</label>
                        <input type="date" name="endDate" [disabled]="!newAssignment.startDate" [min]="newAssignment.startDate" [(ngModel)]="newAssignment.endDate" class="form-control form-control-sm" required>
                      </div>


                      <div class="col-12 mt-2 mb-2" *ngIf="newAssignment?.typeCategory==1">
                        <div class="card">
                          <div class="card-header p-2">
                            <strong class="text-primary-color">
                              Datos para la Generación del Horario de Asignación
                            </strong>
                          </div>
                          <div class="card-body p-2">
                            <div class="form-row">
                              <div class="col-3">
                                <label for="timeDurationSession">Duración de Sesión (min)</label>
                                <input type="text" name="timeDurationSession" maxlength="3" (keypress)="onlyNumbers($event)" (change)="resetDistribution()" [(ngModel)]="newAssignment.timeDurationSession" class="form-control form-control-sm" required>
                              </div>
                              <div class="col-3">
                                <label for="startHourDay">Hora Inicio</label>
                                <input type="time" name="startHourDay" [(ngModel)]="newAssignment.startHourDay" (change)="calculateNextHour()" (blur)="calculateNextHour()" class="form-control form-control-sm" required>
                              </div>
                              <div class="col-3">
                                <label for="endHourDay">Hora Fin</label>
                                <input type="time" name="endHourDay" [min]="newAssignment.nextMinHour" (blur)="validateHour()" (keyup)="validateHour()" (change)="validateHour()" [disabled]="!newAssignment.startHourDay" [(ngModel)]="newAssignment.endHourDay" class="form-control form-control-sm" required>
                              </div>
                              <div class="col-3 pt-2">
                                <button class="btn btn-sm btn-block bg-primary-color" [disabled]="!newAssignment.timeDurationSession || !newAssignment.startHourDay || !newAssignment.endHourDay" (click)="generateTimeDistribution()">
                                  <i class="fa fa-cog mr-1"></i>Preparar Distribución
                                </button>
                              </div>
                            </div>
                          </div>
                          <div class="card-body p-2 mt-2">
                            <ng-container class="form-row" *ngIf="timeDistributionGenerated">
                              <div class="col-5">
                                <strong class="text-primary-color text-uppercase mr-2">Distribución Horaria</strong>
                                <span class="badge badge-light">
                                  <i class="fa fa-circle-o mr-1 text-secondary"></i>Total&nbsp;({{newAssignment.totals}})
                                </span>
                              </div>
                              <div class="col-7 text-right">
                                <span class="badge badge-light mr-1">
                                  <i class="fa fa-circle mr-1 text-danger"></i>Ocupado&nbsp;({{newAssignment.inBusy}})
                                </span>
                                <span class="badge badge-light mr-1">
                                  <i class="fa fa-circle mr-1 text-success"></i>Seleccionado&nbsp;({{newAssignment.inSelect}})
                                </span>
                                <span class="badge badge-light">
                                  <i class="fa fa-circle mr-1 text-info"></i>Libre&nbsp;({{newAssignment.inFree}})
                                </span>
                              </div>
                              <div class="col-12 mt-2" style="max-height: 400px; overflow: auto;">
                                <table class="table table-bordered table-sm">
                                  <thead>
                                    <tr>
                                      <th>Hora</th>
                                      <th class="text-center" style="width: 13%;" *ngFor="let d of headerTimeDistribution">
                                        {{d.dayLetter | uppercase}} <br>
                                        {{d.date}}
                                      </th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    <tr *ngFor="let h of schedule">
                                      <td>
                                        {{h.config[0].initLetter}}
                                        <br>-<br>
                                        {{h.config[0].finishLetter}}
                                      </td>
                                      <td *ngFor="let d of h.config" style="vertical-align: middle;" class="mt-3 mb-3 text-center hand" (click)="toggleSelectHour(d)" [ngClass]="{'table-danger text-white denied': d.isBusy, 'bg-success text-white': d.isSelected, 'table-info': !d.isBusy && !d.isSelected}">
                                        <small>
                                          <span *ngIf="d.isBusy">Ocupado</span>
                                          <ng-container *ngIf="!d.isBusy">
                                            <span *ngIf="d.isSelected"><i class="fa fa-check-circle fa-2x"></i><br>Seleccionado</span>
                                            <span *ngIf="!d.isSelected">Libre</span>
                                          </ng-container>
                                        </small>
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                              </div>
                            </ng-container>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </tab>
              <tab heading="Certificación">
                <div class="card">
                  <div class="card-body">
                    <div class="form-row">
                      <div class="col-12">
                        <label for="subtitle">Subtítulo del documento<span class="ml-1 text-secondary hand" (click)="ussageExample('subtitle', exampleSubtitle)">(Ejemplo: {{exampleSubtitle}})</span></label>
                        <textarea name="subtitle" rows="2" [(ngModel)]="newAssignment.subtitle" class="form-control text-uppercase" required></textarea>
                      </div>
                      <div class="col-12">
                        <label for="organizes">Organizador<span class="ml-1 text-secondary hand" (click)="ussageExample('organizes', exampleOrganizes)">(Ejemplo: {{exampleOrganizes}})</span></label>
                        <textarea name="organizes" rows="4" [(ngModel)]="newAssignment.organizes" class="form-control text-uppercase" required></textarea>
                      </div>
                      <div class="col-12 mt-3">
                        <div class="card">
                          <div class="card-header">
                            <div class="form-row">
                              <div class="col-9 pt-1">
                                <i class="fa fa-font mr-1"></i>Firmantes del Certificado
                              </div>
                              <div class="col-3 text-right">
                                <button class="btn btn-sm bg-primary-color" *ngIf="signatories.length <1" (click)="toggleSignatories()">
                                  <i class="fa fa-plus mr-1"></i>Agregar
                                </button>
                              </div>
                            </div>
                          </div>
                          <ul class="list-group list-group-flush">
                            <li class="list-group-item" *ngFor="let s of signatories; let i = index">
                                <div class="form-row">
                                  <div class="col-4" [ngClass]="{'pt-1': s.type === 1}">
                                    <strong><small>Nombre de Persona</small></strong> <br>
                                    <span *ngIf="s.type === 1">{{s.nameFirms | uppercase}}</span>
                                    <input type="text" *ngIf="s.type === 2 || !s.type" name="nameFirms-{{i}}" placeholder="DATOS DE LA PERSONA PARA LA FIRMA" [(ngModel)]="s.nameFirms" class="form-control form-control-sm text-uppercase">
                                  </div>
                                  <div class="col-3">
                                    <strong><small>Cargo</small></strong> <br>
                                    <input type="text" name="positionFirms-{{i}}" placeholder="CARGO PARA LA FIRMA" [(ngModel)]="s.positionFirms" class="form-control form-control-sm text-uppercase">
                                  </div>
                                  <div class="col-4">
                                    <strong><small>Imagen de la Firma</small></strong> <br>
                                    <button class="btn btn-sm btn-light text-primary-color" *ngIf="s.urlFileFirm" (click)="resetFile(s)">
                                      <i class="fa fa-circle mr-1"></i>Click para cambiar archivo subido
                                    </button>
                                    <input type="file" id="signature-{{s.index}}" *ngIf="!s.urlFileFirm" name="signature-{{i+1}}" accept=".jpg,.jpeg,.png" [(ngModel)]="s.fileSignature" class="form-control form-control-sm" required>
                                  </div>
                                  <div class="col-1 text-right">
                                    <button class="btn btn-sm btn-danger rounded-circle" (click)="toggleSignatories(s, i)">
                                      <i class="fa fa-trash"></i>
                                    </button>
                                  </div>
                                </div>
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </tab>
            </tabset>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" bsModal #selectTypeSignatorie="bs-modal" [config]="{backdrop: 'static'}" tabindex="-1" role="dialog" aria-labelledby="dialog-static-name">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body">
        <div class="form-row mb-3">
          <div class="col-9 pt-1">
            <strong class="text-primary-color">
              Seleccione el tipo de Persona a firmar
            </strong>
          </div>
          <div class="col-3 text-right">
            <button class="btn btn-sm btn-danger" (click)="toggleTypeSignatorie()">
              <i class="fa fa-times mr-1"></i>Cancelar
            </button>
          </div>
          <div class="col-12">
            <hr>
          </div>
          <div class="col-2"></div>
          <div class="col-8">
            <div class="form-row">
              <div class="col-6" *ngFor="let t of typeSignatories">
                <div class="card hand" [ngClass]="{'bg-primary-color': typeSignatorySelected.id === t.id}" (click)="selectTypeSignatory(t)">
                  <div class="card-body">
                    <div class="form-row">
                      <div class="col-12 mb-2 mt-1 text-center">
                        <i class="{{t.icon}} fa-2x"></i> <br>
                        <span class="font-lg">{{t.name | uppercase}}</span>
                      </div>
                      <div class="col-12 text-center"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-2"></div>
          <div class="col-12 mt-4 text-center" *ngIf="typeSignatorySelected.id">
            <button class="btn bg-primary-color" (click)="choiceTypeSignatory()">
              Seleccionar Tipo de Persona
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div bsModal #usersModal="bs-modal" class="modal fade" tabindex="-1" aria-labelledby="usersModalLabel" role="dialog">
  <div class="modal-dialog modal-lg modal-dialog-centered"> <!-- Agregué 'modal-lg' para que sea más ancho -->
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="usersModalLabel">Agregar Docente Externo</h3>
        <button type="button" class="close" aria-label="Close" (click)="toggleUsersModal();">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form [formGroup]="externalTeacherForm" (submit)="onSubmitUsers()" autocomplete="off">
          <div class="row">
            <div class="col-6">
              <mat-form-field class="width" appearance="outline">

                <mat-label>Tipo de Documento</mat-label>
                <mat-select #selectTypeDocument formControlName="p_typeDocument" (selectionChange)="getPersonByDocumentNumber(selectTypeDocument.value)">
                  <mat-option *ngFor="let option of typeDocument" [value]="option.typeDocId">
                    <span>
                      {{ option.typeDocName}}
                    </span>
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="externalTeacherForm.get('p_typeDocument').invalid && externalTeacherForm.get('p_typeDocument').touched">
                  Tipo Documento es <strong>requerido</strong>
                </mat-error>
              </mat-form-field>
            </div>
            <div class="col-6">
              <mat-form-field class="width" appearance="outline">
                <mat-label>Nro de Documento</mat-label>
                <input type="text" matInput formControlName="p_numberDocument">
                <mat-error *ngIf="externalTeacherForm.get('p_numberDocument')?.hasError('required') && externalTeacherForm.get('p_numberDocument')?.touched">
                  Nro de Documento es <strong>requerido</strong>
                </mat-error>
                <mat-error *ngIf="externalTeacherForm.get('p_numberDocument')?.hasError('minLengthDoc') && externalTeacherForm.get('p_numberDocument')?.touched">
                  {{ externalTeacherForm.get('p_numberDocument')?.getError('minLengthDoc') }}
                </mat-error>

              </mat-form-field>
            </div>
            <div class="col-6">
              <mat-form-field class="width" appearance="outline">
                <mat-label>Nombres</mat-label>
                <input type="text" matInput formControlName="p_name">
                <mat-error *ngIf="externalTeacherForm?.get('p_name')?.invalid && externalTeacherForm?.get('p_name')?.touched">
                  Nombres es <strong>requerido</strong>
                </mat-error>
              </mat-form-field>
            </div>
            <div class="col-6">
              <mat-form-field class="width" appearance="outline">
                <mat-label>Apellido Paterno</mat-label>
                <input type="text" matInput formControlName="p_lastName">
                <mat-error *ngIf="externalTeacherForm?.get('p_lastName')?.invalid && externalTeacherForm?.get('p_lastName')?.touched">
                  Apellido Paterno es <strong>requerido</strong>
                </mat-error>
              </mat-form-field>
            </div>
            <div class="col-6">
              <mat-form-field class="width" appearance="outline">
                <mat-label>Apellido Materno</mat-label>
                <input type="text" matInput formControlName="p_secondName">
                <mat-error *ngIf="externalTeacherForm?.get('p_secondName')?.invalid && externalTeacherForm?.get('p_secondName')?.touched">
                  Apellido Materno es <strong>requerido</strong>
                </mat-error>
              </mat-form-field>
            </div>
            <div class="col-6">
              <mat-form-field class="width" appearance="outline">
                <mat-label>Correo electrónico</mat-label>
                <input type="text" matInput formControlName="p_email">
                <mat-error *ngIf="externalTeacherForm?.get('p_email')?.invalid && externalTeacherForm?.get('p_email')?.touched">
                  Correo electrónico es <strong>requerido</strong>
                </mat-error>
              </mat-form-field>
            </div>
            <div class="col-6">
              <mat-form-field class="width" appearance="outline">
                <mat-label>Teléfono</mat-label>
                <input type="text" matInput formControlName="p_phone">
                <mat-error *ngIf="externalTeacherForm.get('p_phone')?.hasError('required') && externalTeacherForm.get('p_phone')?.touched">
                  Teléfono es <strong>requerido</strong>
                </mat-error>

                <mat-error *ngIf="externalTeacherForm.get('p_phone')?.hasError('pattern') && externalTeacherForm.get('p_phone')?.touched">
                  Solo se permiten <strong>números</strong>
                </mat-error>

                <mat-error *ngIf="externalTeacherForm.get('p_phone')?.hasError('minlength') && externalTeacherForm.get('p_phone')?.touched">
                  El teléfono debe tener al menos <strong>10 dígitos</strong>
                </mat-error>

                <mat-error *ngIf="externalTeacherForm.get('p_phone')?.hasError('maxlength') && externalTeacherForm.get('p_phone')?.touched">
                  El teléfono no debe tener más de <strong>10 dígitos</strong>
                </mat-error>
              </mat-form-field>
            </div>
          </div>
        </form>
      </div>
      <!-- FOOTER DEL MODAL -->
      <div class="modal-footer">
        <button type="button" mat-raised-button class="styleButton_gray" (click)="toggleUsersModal();">
          Cerrar
        </button>
        <button type="submit" mat-raised-button color="primary" (click)="onSubmitUsers()">
          Crear
        </button>
      </div>
    </div>
  </div>
</div>
