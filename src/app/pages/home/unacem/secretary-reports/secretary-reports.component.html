<div class="row animated fadeIn fast" *ngIf="isLoading; else body;">
  <div class="col-md-12">
    <div class="alert alert-info text-center">
      <h4 class="alert-heading">Cargando</h4>
      <i class="fa fa-spin fa-refresh fa-3x"></i>
      <p class="mb-0">Por favor esperar...</p>
    </div>
  </div>
</div>
<ng-template #body>
  <div class="animated fadeIn fast">
    <div class="form-row">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-primary-color">
            <div class="form-row">
              <div class="col-9">
                <i class="fa fa-cog mr-1"></i>
                Reportes Secretaría
              </div>
            </div>
          </div>
          <div class="card-body" [formGroup]="filtersForm">
            <div class="row pl-2 pr-2">
              <div class="col-3" style="text-align: center;">
                <mat-form-field class="width" appearance="outline">
                  <mat-label>Contratista</mat-label>
                  <mat-select formControlName="contractorID" (selectionChange)="getContractorCollaborator($event.value);
                  getUnacemStudentsReport(); filtersForm.get('personID').patchValue(0); getUnacemCourseByContractor()">
                    <mat-option [value]="0">Todos</mat-option>
                    <mat-option *ngFor="let item of contractors" [value]="item.contractorID">
                      {{item.businessName}}
                    </mat-option>
                  </mat-select>
                  <mat-error><small>Campo requerido</small></mat-error>
                </mat-form-field>
              </div>
              <div class="col-3" style="text-align: center;">
                <mat-form-field class="width" appearance="outline">
                  <mat-label>Colaborador</mat-label>
                  <mat-select formControlName="personID" (selectionChange)="getUnacemStudentsReport();
                  getUnacemCourseByContractor(); filtersForm.get('courseID').patchValue(0);">
                    <mat-option [value]="0">Todos</mat-option>
                    <mat-option *ngFor="let item of collaborators" [value]="item.personID">
                      {{item.personFullName}}
                    </mat-option>
                  </mat-select>
                  <mat-error><small>Campo requerido</small></mat-error>
                </mat-form-field>
              </div>
              <div class="col-2" style="text-align: center;">
                <mat-form-field class="width" appearance="outline">
                  <mat-label>Curso</mat-label>
                  <mat-select formControlName="courseID" (selectionChange)="getUnacemStudentsReport();">
                    <mat-option [value]="0">Todos</mat-option>
                    <mat-option *ngFor="let item of courses" [value]="item.courseID">{{item.courseName}}</mat-option>
                  </mat-select>
                  <mat-error><small>Campo requerido</small></mat-error>
                </mat-form-field>
              </div>
              <div class="col-2" style="text-align: center;">
                <mat-form-field class="width" appearance="outline">
                  <mat-label>Inicio</mat-label>
                  <input type="date" formControlName="startDate" #startDate matInput (click)="startDate.showPicker()"
                  (change)="getUnacemStudentsReport();">
                  <mat-icon style="cursor: pointer;" matSuffix (click)="startDate.showPicker()">calendar_month</mat-icon>
                  <mat-hint>dd/mm/aaaa</mat-hint>
                  <mat-error><small>Campo requerido</small></mat-error>
                </mat-form-field>
              </div>
              <div class="col-2" style="text-align: center;">
                <mat-form-field class="width" appearance="outline">
                  <mat-label>Fin</mat-label>
                  <input type="date" formControlName="endDate" #endDate matInput (click)="endDate.showPicker()" [min]="startDate.value"
                  (change)="getUnacemStudentsReport();">
                  <mat-icon style="cursor: pointer;" matSuffix (click)="endDate.showPicker()">calendar_month</mat-icon>
                  <mat-hint>dd/mm/aaaa</mat-hint>
                  <mat-error><small>Campo requerido</small></mat-error>
                </mat-form-field>
              </div>
              <div class="col-4" style="text-align: center;">
                <mat-form-field class="width" appearance="outline">
                  <mat-label>Búsqueda</mat-label>
                  <input type="text" matInput formControlName="filter">
                  <mat-error><small>Campo requerido</small></mat-error>
                </mat-form-field>
              </div>
              <div class="col" *ngIf="ROL.UNACEM_SUPERVISOR === currentRol">
                <button
                  class="download-button mr-2"
                  mat-raised-button
                  matTooltipPosition="above"
                  matTooltip="Descargar Excel"
                  (click)="openFile('api/unacem-report/students-report');">
                  <small>Participantes</small>
                  <mat-icon class="green-icon">description</mat-icon>
                </button>
                <button
                  class="download-button mr-2"
                  mat-raised-button
                  matTooltipPosition="above"
                  matTooltip="Descargar Excel"
                  (click)="openFile('api/unacem-report/theory-notes-report');">
                  <small>N. virtual aprobados</small>
                  <mat-icon class="green-icon">description</mat-icon>
                </button>
                <button
                  class="download-button mr-2"
                  mat-raised-button
                  matTooltipPosition="above"
                  matTooltip="Descargar PDF"
                  (click)="openFile('api/unacem-report/all-qr-report', true);">
                  <small>Reporte General de QR</small>
                  <mat-icon class="red-icon">description</mat-icon>
                </button>
                <button mat-raised-button class="styleButton_sml mr-2"
                (click)="filtersForm.get('isShowing').patchValue(!filtersForm.get('isShowing').value)">
                  <small>{{filtersForm.get('isShowing').value ? 'Presencial' : 'Virtual'}}</small>
                </button>
              </div>
              <div class="col-12">
                <span class="badge bg-secondary mr-2 font-sm hand">
                  TOTAL: {{reportList[0]?.total}}
                </span>
                <span class="badge mr-2 font-sm hand" style="background-color: green;">
                  T. APROBADOS: {{reportList[0]?.totalApproved}}
                </span>
                <span class="badge bg-danger mr-2 font-sm hand">
                  T. REPROBADOS: {{reportList[0]?.totalFailed}}
                </span>
                <span class="badge bg-warning mr-2 font-sm hand">
                  T. CADUCADOS: {{reportList[0]?.totalExpired}}
                </span>
                <span class="badge bg-info mr-2 font-sm hand">
                  T. EN CURSO: {{reportList[0]?.totalInProgress}}
                </span>
              </div>
            </div>
            <div class="row">
              <div class="col-12">
                <div class="table-responsive">
                  <table class="table">
                    <thead style="background-color: #004899; color: white;">
                      <tr>
                        <th><small>Fecha inscripción</small></th>
                        <th><small>Curso</small></th>
                        <th><small>Nro documento</small></th>
                        <th><small>Estudiante</small></th>
                        <th><small>
                          Fecha evaluación
                          {{filtersForm.get('isShowing').value ? 'virtual' : 'presencial'}}
                        </small></th>
                        <th><small>
                          Nota evaluación
                          {{filtersForm.get('isShowing').value ? 'virtual' : 'presencial'}}
                        </small></th>
                        <th><small>
                          Nota recuperación
                          {{filtersForm.get('isShowing').value ? 'virtual' : 'presencial'}}
                        </small></th>
                        <th><small>Estado general</small></th>
                        <th><small>Fecha caducidad</small></th>
                        <th><small>Código QR</small></th>
                      </tr>
                    </thead>
                    <tbody style="color: black;">
                      <tr *ngFor="let item of reportList">
                        <td><small>{{item.inscriptionDate}}</small></td>
                        <td><small>{{item.courseName}}</small></td>
                        <td><small>{{item.personDocumentNumber}}</small></td>
                        <td><small>{{item.fullNameStudent}}</small></td>
                        <td><small>
                          {{filtersForm.get('isShowing').value ? item.lastDateTheory : item.lastDateInPerson}}
                        </small></td>
                        <td><small>
                          {{filtersForm.get('isShowing').value ? item.gradeTheory : item.gradeInPerson}}
                        </small></td>
                        <td><small>
                          {{filtersForm.get('isShowing').value ? item.gradeTheoryRecovery : item.gradeInPersonRecovery}}
                        </small></td>
                        <td><small>{{item.statusGrade}}</small></td>
                        <td><small>{{item.validityDate}}</small></td>
                        <td><small>
                          <a class="text-primary fw-bold"
                          matTooltip="Ver QR"
                          style="cursor: pointer;"
                          (click)="getQr(item.personID)">
                            <i class="fa fa-qrcode fa-3x"></i>
                          </a>
                        </small></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <mat-paginator
                  #paginator
                  [length]="length"
                  [pageSize]="pageSize"
                  [pageSizeOptions]="pageSizeOptions"
                  (page)="pageEvent = getPaginator($event)">
                </mat-paginator>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>
