<div class="animated fadeIn fast">
  <div class="form-row">
    <div class="col-12">
      <div class="card" *ngIf="!allowed">
        <div class="card-body text-center text-danger">
          <div class="form-row">
            <div class="col-12">
              <i class="fa fa-times fa-3x"></i><br>
              <span class="font-xl">
                No estas permitido para visualizar los reportes de esta sección.
              </span>
            </div>
          </div>
        </div>
      </div>
      <div class="card" *ngIf="allowed">
        <div class="card-header bg-primary-color">
          <div class="form-row">
            <div class="col-9">
              <i class="fa fa-cog mr-1"></i>Reportería
              <span class="badge bg-white font-nm text-primary-color float-right" *ngIf="entitySelected.contractorID"><strong>ENTIDAD:</strong>&nbsp;{{entitySelected.businessName | uppercase}}</span>
            </div>
            <div class="col-3 text-right">
              <button class="btn btn-sm btn-light text-primary-color" *ngIf="rolID === 22 && personID === 569" [disabled]="!filter.periodSection" (click)="credentialReport()">
                <i class="fa fa-key mr-1"></i>Credenciales
              </button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="form-row">
            <!-- <div class="col-12">
              <label for="reportTypeID">Tipo de Reporte</label>
              <select name="reportTypeID" [(ngModel)]="filter.reportTypeID" (change)="resetResult()" class="form-control form-control-sm">
                <option [ngValue]="undefined">--SELECCIONE--</option>
                <option *ngFor="let r of reportTypes" [ngValue]="r.id">{{r.name | uppercase}}</option>
              </select>
            </div> -->
            <!-- FILTROS -->
             <div class="col-12" *ngIf="filter.reportTypeID">
               <div class="card">
                 <div class="card-header">
                   Filtros
                 </div>
                 <div class="card-body" *ngIf="filter.reportTypeID === 1">
                   <div class="form-row">
                     <div class="col-xs-12 col-sm-2 col-md-2 col-lg-2">
                       <label for="periodSection">Periodo</label>
                       <select name="periodSection" [(ngModel)]="filter.periodSection" class="form-control form-control-sm">
                         <option [ngValue]="undefined">--SELECCIONE--</option>
                         <option *ngFor="let y of currentYear-10 | range:currentYear" [ngValue]="y">{{y}}</option>
                       </select>
                     </div>
                     <div class="col-xs-12 col-sm-2 col-md-2 col-lg-2">
                      <label for="startDate">Inicio</label>
                      <input type="date" name="startDate" [(ngModel)]="filter.startDate" class="form-control form-control-sm">
                    </div>
                    <div class="col-xs-12 col-sm-2 col-md-2 col-lg-2">
                      <label for="endDate">Fin</label>
                      <input type="date" [disabled]="!filter.startDate" [min]="filter.startDate" name="endDate" [(ngModel)]="filter.endDate" class="form-control form-control-sm">
                    </div>
                    <div class="col-xs-12 col-sm-2 col-md-2 col-lg-2">
                      <label for="contractorID">Contratista</label>
                      <select name="contractorID" [(ngModel)]="filter.contractorID" [disabled]="filter.isMain" class="form-control form-control-sm" (change)="selectContractor()">
                        <option [ngValue]="undefined">--TODOS--</option>
                        <option *ngFor="let c of contractors" [ngValue]="c.contractorID">{{c.businessName | uppercase}}</option>
                      </select>
                    </div>
                    <div class="col-xs-12 col-sm-2 col-md-2 col-lg-2">
                      <label for="personID">Colaborador</label>
                      <select name="personID" [(ngModel)]="filter.personID" [disabled]="!filter.contractorID" class="form-control form-control-sm">
                        <option [ngValue]="undefined">--TODOS--</option>
                        <option *ngFor="let c of collaborators" [ngValue]="c.personID">{{c.personDocumentNumber}} - {{c.personFullName | uppercase}}</option>
                      </select>
                    </div>
                    <div class="col-xs-12 col-sm-2 col-md-2 col-lg-2">
                      <label for="statusGradeID">Estado</label>
                      <select name="statusGradeID" [(ngModel)]="filter.statusGradeID" class="form-control form-control-sm">
                        <option *ngFor="let c of statusGrades" [ngValue]="c.statusGradeID">{{c.statusGrade | uppercase}}</option>
                      </select>
                    </div>
                    <div class="col-xs-12 col-sm-2 col-md-2 col-lg-2">
                      <button class="btn btn-sm btn-block mt-2 bg-primary-color" [disabled]="!filter.periodSection" (click)="search()">
                        <i class="fa fa-cog mr-1"></i>Generar
                      </button>
                    </div>
                  </div>
                 </div>
               </div>
             </div>
            <div class="col-12" *ngIf="results.length && searched">
              <div class="form-row">
                <div class="col-12">
                  <hr>
                </div>
                <div class="col-4">
                  <input type="text" name="filter.text" [(ngModel)]="filter.text" placeholder="BUSCAR POR DOCUMENTO, CONTRATISTA, CURSO, ESTUDIANTE" class="form-control form-control-sm text-uppercase">
                </div>
                <div class="col-2">
                  <button class="btn btn-sm bg-primary-color btn-block" (click)="downloadReport()">
                    <i class="fa fa-download mr-1 "></i>Descargar
                  </button>
                </div>
                <div class="col-2">
                  <button class="btn btn-sm bg-light mr-2 border-primary-color btn-block" (click)="downloadQRReport()">
                    <i style="color: red;" class="fa fa-file-pdf-o mr-1"></i>Reporte General de QR
                  </button>
                </div>
                <div class="col-2">
                  <button class="btn btn-sm bg-light mr-2 border-primary-color btn-block" [matMenuTriggerFor]="reports">
                    <i style="color: blue;" class="fa fa-file-archive-o mr-1"></i>Reportes
                  </button>
                  <mat-menu #reports="matMenu">
                    <button
                      mat-menu-item
                      matTooltipPosition="above"
                      matTooltip="Descargar Excel"
                      (click)="generateReport('api/unacem-report/state-percentage-course');">
                      Reporte Cursos
                      <mat-icon class="green-icon">assignment</mat-icon>
                    </button>
                    <button
                      mat-menu-item
                      matTooltipPosition="above"
                      matTooltip="Descargar Excel"
                      (click)="generateReport('api/unacem-report/hours-unacem-report');">
                      Reporte Horas
                      <mat-icon class="green-icon">assignment</mat-icon>
                    </button>
                    <button
                      mat-menu-item
                      matTooltipPosition="above"
                      matTooltip="Descargar Excel"
                      (click)="generateReport('api/unacem-report/desertion-unacem-report');">
                      Reporte Deserciones
                      <mat-icon class="green-icon">assignment</mat-icon>
                    </button>
                    <button
                      mat-menu-item
                      matTooltipPosition="above"
                      matTooltip="Descargar Excel"
                      (click)="generateReport('api/unacem-report/desertion-by-phase');">
                      Reporte deserciones por fase
                      <mat-icon class="green-icon">assignment</mat-icon>
                    </button>
                    <button
                      mat-menu-item
                      matTooltipPosition="above"
                      matTooltip="Descargar Excel"
                      (click)="generateReport('api/unacem-report/user-moodle-report');">
                      Reporte usuarios moodle
                      <mat-icon class="green-icon">assignment</mat-icon>
                    </button>
                    <button
                      mat-menu-item
                      matTooltipPosition="above"
                      matTooltip="Descargar Excel"
                      (click)="generateReport('api/unacem-report/general-unacem-report');">
                      Reporte General
                      <mat-icon class="green-icon">assignment</mat-icon>
                    </button>
                  </mat-menu>
                </div>
                <div class="col-lg-12 pt-1">
                  <span class="badge bg-light border-primary-color text-primary-color mr-2 font-sm hand">
                    TOTAL: {{results.length}}
                  </span>
                  <span class="badge {{t.bg}} mr-2 font-sm hand" (click)="toggleTotalSelected(t)" *ngFor="let t of totals">
                    {{t.title}}: {{t.value}}
                    <i class="fa fa-circle ml-2" *ngIf="t.statusGradeID === totalSelected.statusGradeID"></i>
                  </span>
                </div>
                <div class="col-12 mt-3">
                </div>
                <div class="col-12 ">
                  <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                      <thead class="bg-primary-color">
                        <tr>
                          <th style="vertical-align: middle;" class="font-sm" *ngFor="let f of fields">{{f.name | uppercase}}</th>
                          <th style="vertical-align: middle;" class="font-sm">ACCIONES</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr class="{{totalSelected.statusGradeID === r.statusGradeID ? r.bg+' text-white' : ''}}" *ngFor="let r of results | filter:filter.text; let i = index">
                          <td *ngFor="let f of fields">{{formatValueByField(f.field, r[f.field])}}</td>
                          <td>
                            <button mat-icon-button [matMenuTriggerFor]="menu" style="color: #014898;">
                              <mat-icon>more_vert</mat-icon>
                            </button>
                            <mat-menu #menu="matMenu">
                              <button mat-menu-item *ngIf="!!r['flgQr']"
                              (click)="showModalQr(r.personID)">
                                <i style="color: #014898;" class="fa fa-qrcode fa-2x"></i>
                                &nbsp;<span>QR</span>
                              </button>
                              <button mat-menu-item *ngIf="!!r['flgQr']"
                              (click)="openFile('api/unacem-report/unic-qr-report', r.personID);">
                                <i style="color: red;" class="fa fa-file-pdf-o" aria-hidden="true"></i>
                                &nbsp;<span>Descargar QR</span>
                              </button>
                              <button mat-menu-item
                              (click)="openFile('api/unacem-certificate/with-template', r.personID, r.classSectionNumber);">
                                <i style="color: red;" class="fa fa-file-pdf-o" aria-hidden="true"></i>
                                &nbsp;<span>Generar Certificado</span>
                              </button>
                            </mat-menu>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" bsModal #entityModal="bs-modal" [config]="{backdrop: 'static'}" tabindex="-1" role="dialog" aria-labelledby="dialog-static-name">
	<div class="modal-dialog modal-nm">
		<div class="modal-content">
			<div class="modal-body p-5">
        <form #enrollInBulkForm="ngForm">
          <div class="form-row">
            <div class="col-12 text-center">
              <strong class="text-primary-color font-lg">Seleccione la Entidad con la que trabajara:</strong>
            </div>
            <div class="col-12 mt-5">
              <div class="form-row">
                <div class="" [ngClass]="{'col': entities.length<=2, 'col-4': entities.length>3}" *ngFor="let e of entities" (click)="toggleSelectEntity(e)">
                  <div class="card hand" [ngClass]="{'bg-primary-color': e.isSelected, 'text-primary-color': !e.isSelected}">
                    <div class="card-body pt-5 pb-5 text-center">
                      <i class="fa fa-building fa-4x"></i><br>
                      <p class="mt-3 text-center">
                        <strong class="font-xl">{{e.businessName | uppercase}}</strong><br>
                        <span>{{e.businessAddress | uppercase}}</span>
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12 mt-5 text-right" *ngIf="entitySelected">
              <button class="btn bg-primary-color"  (click)="toggleEntityModal()">
                <i class="fa fa-check mr-1"></i>Continuar
              </button>
            </div>
          </div>
        </form>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" bsModal #qrModal="bs-modal" tabindex="-1" role="dialog" aria-labelledby="dialog-static-name">
  <div class="modal-dialog modal-nm">
    <div class="modal-content">
      <div class="modal-body p-5">
        <img *ngIf="imageBase64" [src]="imageBase64" alt="Código QR" class="img-fluid w-100 h-100" />
      </div>
    </div>
  </div>
</div>
